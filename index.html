<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BIN → CSV / Excel</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#160a20;
    --card:#853e88c5;
    --accent:#ff6ad5;
    --accent-2:#ffb6e6;
    --btn:#be4ebb;
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: Arial, Helvetica, sans-serif;
    background: var(--bg) url('fondo.png') center/cover no-repeat;
    color: #fff;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .card{
    width:100%;
    max-width:880px;
    background: linear-gradient(180deg, rgba(133,62,136,0.85), rgba(120,45,120,0.7));
    border-radius:18px;
    padding:20px;
    box-shadow: 0 8px 30px rgba(135,48,114,0.6);
    backdrop-filter: blur(6px);
  }
  h1{font-size:20px;margin:6px 0 12px;text-align:center}
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .left, .right {display:flex; gap:10px; align-items:center;}
  input[type="file"]{
    border-radius:10px;
    padding:8px;
    background: rgba(255,255,255,0.06);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.06);
  }
  button{
    background:var(--btn);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
  }
  button:active{transform: translateY(1px);}
  #grafica-wrap{
    margin-top:14px;
    border-radius:12px;
    padding:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 2px solid rgba(255,135,216,0.08);
  }
  canvas{
    width:100% !important;
    height:320px !important;
    display:block;
    border-radius:8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  }
  .status{ margin-top:10px; text-align:center; font-size:13px; color:var(--accent-2) }
  .small{ font-size:12px; color:#ffe6f5 }
  .controls .settings{ display:flex; gap:8px; align-items:center; }
  select,input[type="number"]{ padding:6px;border-radius:8px;border:none; background: rgba(255,255,255,0.04); color:#fff }
  @media(max-width:640px){ .controls{ flex-direction:column; align-items:stretch } .left,.right{width:100%;justify-content:space-between} }
</style>
</head>
<body>

<div class="card">
  <h1>Convertidor BIN → CSV / Excel </h1>

  <div class="controls">
    <div class="left">
      <input id="binFile" type="file" accept=".bin" />
      <button id="btnLoad">Cargar</button>
      <button id="btnCSV">Descargar CSV</button>
    <button id="btnXLS">Descargar Excel</button>
    </div>

    <div class="right">
      <div class="settings small">
        Ventana:
        <input id="windowSize" type="number" min="100" max="2000" step="50" value="600" style="width:80px" />
      </div>
      <div class="settings small">
        Velocidad (ms):
        <input id="speedMs" type="number" min="1" max="100" step="1" value="6" style="width:70px" />
      </div>
    </div>
  </div>

  <div id="grafica-wrap">
    <canvas id="graficaECG"></canvas>
  </div>

  <div class="status" id="status">No hay archivo cargado</div>
</div>

<script>
(() => {
  // Variables globales 
  let valores = [];           // array de enteros leídos del BIN
  let chart = null;
  let windowSize = 600;       // cantidad de puntos visibles
  let speedMs = 6;            // intervalo de actualización (ms)
  let playInterval = null;
  let playIndex = 0;
  let bufferWindow = [];      // ventana actual (Array length == windowSize)
  const MAX_ROWS_PER_SHEET = 1048575; // Excel safe per-sheet rows (one less to be safe)

  //  DOM 
  const fileInput = document.getElementById('binFile');
  const btnLoad = document.getElementById('btnLoad');
  const btnCSV = document.getElementById('btnCSV');
  const btnXLS = document.getElementById('btnXLS');
  const status = document.getElementById('status');
  const canvas = document.getElementById('graficaECG').getContext('2d');
  const inputWindow = document.getElementById('windowSize');
  const inputSpeed = document.getElementById('speedMs');

  // Inicializar Chart.js con apariencia rosa ECG 
  function initChart(ws) {
    // Si existía, destruirla
    if (chart) { chart.destroy(); chart = null; }

    // preparar ventana con nulls para que quede vacío al inicio
    bufferWindow = new Array(ws).fill(null);

    chart = new Chart(canvas.canvas, {
      type: 'line',
      data: {
        labels: new Array(ws).fill(''), // etiquetas vacías
        datasets: [{
          data: bufferWindow.slice(),
          borderColor: '#ff6ad5',
          borderWidth: 2,
          tension: 0,          // trazo recto (ECG)
          pointRadius: 0,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: {
            display: true,
            grid: { color: 'rgba(255,182,230,0.12)' },
            suggestedMin: 0,
            suggestedMax: 4096
          }
        },
        elements: { line: { cubicInterpolationMode: 'monotone' } }
      }
    });
  }

  // Leer BIN como Uint16 little-endian 
  async function leerBinComoUint16(file) {
    const ab = await file.arrayBuffer();
    const dv = new DataView(ab);
    const out = [];
    for (let i = 0; i + 1 < dv.byteLength; i += 2) {
      // usar getUint16 (ajusta si tus datos son signed -> cambiar a getInt16)
      out.push(dv.getUint16(i, true));
    }
    return out;
  }

  // Iniciar animación de scroll 
  function comenzarScroll() {
    // limpiar intervalo previo
    if (playInterval) { clearInterval(playInterval); playInterval = null; }

    playIndex = 0;
    // inicializar ventana con nulls
    bufferWindow = new Array(windowSize).fill(null);
    if (chart) {
      chart.data.datasets[0].data = bufferWindow.slice();
      chart.update();
    }

    // si no hay datos, nada por mostrar
    if (!valores || valores.length === 0) return;

    playInterval = setInterval(() => {
      if (playIndex >= valores.length) {
        // detener al llegar al final
        clearInterval(playInterval);
        playInterval = null;
        status.textContent = `Fin de datos — ${valores.length} muestras mostradas`;
        return;
      }
      // desplazar ventana: quitar el primero, añadir el nuevo
      bufferWindow.push(valores[playIndex]);
      bufferWindow.shift();
      // asignar y actualizar chart (más eficiente que reconstruir)
      chart.data.datasets[0].data = bufferWindow;
      chart.update('none'); // actualiza sin animación
      playIndex++;
      // actualizar estado ocasionalmente
      if (playIndex % 1000 === 0) status.textContent = `Reproduciendo: ${playIndex}/${valores.length}`;
    }, speedMs);
  }

  //Descarga CSV idéntico (sin encabezados) 
  function descargarCSV() {
    if (!valores || valores.length === 0) { alert('Primero carga un archivo .bin'); return; }

    // BOM + líneas
    const bom = '\uFEFF';
    const csvText = bom + valores.join('\r\n');

    const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');

    // nombre basado en archivo original si existe
    const f = fileInput.files[0];
    let name = 'datos.csv';
    if (f && f.name) {
      name = f.name.replace(/\.[^/.]+$/, '') + '.csv';
    }
    a.href = url;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 2000);
    status.textContent = `CSV descargado — ${valores.length} filas`;
  }

  //  Descarga Excel sin encabezados, con hojas múltiples 
  function descargarExcel() {
    if (!valores || valores.length === 0) { alert('Primero carga un archivo .bin'); return; }

    try {
      const wb = XLSX.utils.book_new();
      const total = valores.length;
      const rowsPerSheet = Math.min(MAX_ROWS_PER_SHEET, 1000000); // seguridad
      const sheets = Math.ceil(total / rowsPerSheet);

      for (let s = 0; s < sheets; s++) {
        const start = s * rowsPerSheet;
        const end = Math.min(start + rowsPerSheet, total);
        // crear matriz donde cada subarray es una fila con un solo valor — sin encabezado
        const sheetData = [];
        for (let i = start; i < end; i++) sheetData.push([valores[i]]);
        const ws = XLSX.utils.aoa_to_sheet(sheetData);

        // Intento de aplicar relleno rosa (no siempre soportado por todas las builds)
        // Mantener contenido limpio sin índices ni cabeceras (solo valores)
        try {
          const range = XLSX.utils.decode_range(ws['!ref']);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            const cellAddr = XLSX.utils.encode_cell({c:0, r:R});
            const cell = ws[cellAddr];
            if (cell) {
              if (!cell.s) cell.s = {};
              cell.s.fill = { fgColor: { rgb: "FFB6C1" } }; // rosa pastel
            }
          }
        } catch(e) {
          // si falla el estilado simplemente ignorar; los valores estarán correctamente escritos
          console.warn('No fue posible aplicar estilo en todas las celdas:', e);
        }

        XLSX.utils.book_append_sheet(wb, ws, `Hoja_${s+1}`);
      }

      // archivo con nombre basado en archivo .bin
      const f = fileInput.files[0];
      let name = '_Completo.xlsx';
      if (f && f.name) name = f.name.replace(/\.[^/.]+$/, '') + '_.xlsx';

      XLSX.writeFile(wb, name);
      status.textContent = `Excel descargado — ${total} filas en ${sheets} hoja(s)`;
    } catch (err) {
      console.error(err);
      alert('Error generando Excel. Mira la consola para más detalles.');
    }
  }

  //  Eventos UI 
  btnLoad.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) { alert('Selecciona un archivo .bin primero'); return; }

    try {
      status.textContent = 'Leyendo archivo...';
      valores = await leerBinComoUint16(file);
      status.textContent = `Archivo leído: ${valores.length} muestras`;

      // actualizar parámetros desde los inputs
      windowSize = Math.max(100, Math.min(2000, parseInt(inputWindow.value) || 600));
      speedMs = Math.max(1, Math.min(100, parseInt(inputSpeed.value) || 6));

      initChart(windowSize);
      comenzarScroll();
    } catch (e) {
      console.error(e);
      alert('Error leyendo BIN. Revisa la consola.');
      status.textContent = 'Error leyendo archivo';
    }
  });

  btnCSV.addEventListener('click', descargarCSV);
  btnXLS.addEventListener('click', descargarExcel);

  // cambios dinámicos de parámetros mientras se reproduce
  inputWindow.addEventListener('change', () => {
    const w = Math.max(100, Math.min(2000, parseInt(inputWindow.value) || 600));
    windowSize = w;
    if (valores && valores.length > 0) {
      initChart(windowSize);
      // reiniciar reproducción desde el inicio para mantener coherencia
      if (playInterval) { clearInterval(playInterval); playInterval = null; }
      comenzarScroll();
    }
  });

  inputSpeed.addEventListener('change', () => {
    speedMs = Math.max(1, Math.min(100, parseInt(inputSpeed.value) || 6));
    // reiniciar intervalo si está corriendo para tomar nueva velocidad
    if (playInterval) {
      clearInterval(playInterval);
      playInterval = null;
      comenzarScroll();
    }
  });

  // iniciar chart vacío al cargar la página
  initChart(windowSize);
})();
</script>
</body>
</html>

